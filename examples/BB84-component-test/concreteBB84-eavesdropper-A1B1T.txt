#
{xKa,xKb,xBa,xBb,xKe,xBe,xKa1,xKb1,xKa2,xKb2,x,x1,y1,z1} = {1,0,0,0,0,0};
[q1,q2,q3] = [000]
#
Alice1 def Pstr[q1;x].a2b!x.a2b!Sub(xKa1,x).b2a?xKb2.
	(if Sub(xKa1,x)=xKb2 then key1a!Rem(xKa1,x).nil 
	+ if (not Sub(xKa1,x)=xKb2) then msga!0.nil);
Bob1 def a2b?x.a2b?xKa2.b2a!Sub(xKb1,x).
	(if Sub(xKb1,x)=xKa2 then key1b!Rem(xKb1,x).nil 
	+ if (not Sub(xKb1,x)=xKa2) then msgb!0.nil);
Eve def key1e!xKe.nil;
Test def key1a?x1.key1b?y1.key1e?z1.
	(if not x1=y1 then fail!0.nil + if x1=y1 then keye!z1.skey!x1.nil) + msga?x1.msgb?y1.key1e?z1.alarm!0.nil;
BB84 def (Alice||Bob||Alice1||Bob1||Eve||Test)\{a2b,b2a,keya,keyb,A2E,E2B}
{
	Set2=[0.5*|00><00|+0.5*|00><01|+0.5*|00><10|+0.5*|00><11|,0.5*|01><00|+0.5*|01><01|+0.5*|01><10|+0.5*|01><11|,0.5*|10><00|+0.5*|10><01|+0.5*|10><10|+0.5*|10><11|,0.5*|11><00|+0.5*|11><01|+0.5*|11><10|+0.5*|11><11|];
	Set1=[0.707*|0><0|+0.707*|1><0|,0.707*|0><1|+0.707*|1><1|];
	Set20=[|00><00|,|00><01|,|00><10|,|00><11|];
	Set10=[|0><0|,|0><1|];
	Set11=[|1><0|,|1><1|];
	I=[|0><0|+|1><1|];
	H=[0.707*|0><0|+0.707*|0><1|+0.707*|1><0|-0.707*|1><1|];
	M=[|0><0|,|1><1|];
	M2=[0.5*|0><0|+0.5*|0><1|+0.5*|1><0|+0.5*|1><1|,0.5*|0><0|-0.5*|0><1|-0.5*|1><0|+0.5*|1><1|]
}